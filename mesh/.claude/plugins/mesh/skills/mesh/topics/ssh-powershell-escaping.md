# SSH to PowerShell Escaping

Running PowerShell commands via SSH requires careful attention to escaping. This document covers the patterns used in MeSH provisioning.

## The Challenge

When executing PowerShell via SSH, there are multiple layers of interpretation:

```
Local shell → SSH → Remote shell (CMD/PowerShell) → PowerShell execution
```

Each layer has its own quoting and escaping rules.

## Basic Patterns

### Simple Commands

```python
# Check if file exists
check_cmd = 'powershell -Command "Test-Path \'C:\\Program Files\\Tailscale\\tailscale.exe\'"'
ssh_run(host, port, check_cmd)
```

Note:
- Outer quotes are double quotes (for Python string)
- Inner path uses escaped single quotes
- Backslashes are doubled for Python string escaping

### Commands with Variables

```python
# Execute Tailscale with parameters
ts_exe = "C:\\Program Files\\Tailscale\\tailscale.exe"
up_cmd = (
    f"powershell -Command \"& '{ts_exe}' up "
    f"--login-server={server_url} --authkey={auth_key}\""
)
```

Pattern: `& 'path with spaces' arguments`

### Multi-Statement Commands

```python
restart_cmd = (
    'powershell -Command "'
    "Stop-Service Tailscale -Force -ErrorAction SilentlyContinue; "
    "Start-Sleep 2; "
    'Start-Service Tailscale; Start-Sleep 3"'
)
```

Use semicolons to separate statements within the `-Command` string.

## Creating Multi-Line Scripts

The most complex case is creating a PowerShell script file on the remote machine via SSH. The approach used in `remote.py`:

### Step 1: Define Script Lines

```python
lines = [
    "# join-mesh.ps1 - Generated by mesh remote provision",
    f"$ServerUrl = '{server_url}'",
    f"$AuthKey = '{auth_key}'",
    "",
    "Write-Host '=== Joining Mesh Network ===' -ForegroundColor Cyan",
    # ... more lines
]
```

### Step 2: Escape Single Quotes

PowerShell uses doubled single quotes for escaping within single-quoted strings:

```python
for line in lines:
    escaped_line = line.replace("'", "''")
```

Example: `Write-Host 'Hello'` becomes `Write-Host ''Hello''`

### Step 3: Build Set-Content/Add-Content Commands

```python
ps_cmds = ["New-Item -Path 'C:\\temp' -ItemType Directory -Force | Out-Null"]
for i, line in enumerate(lines):
    escaped_line = line.replace("'", "''")
    if i == 0:
        ps_cmds.append(f"Set-Content '{script_path}' '{escaped_line}'")
    else:
        ps_cmds.append(f"Add-Content '{script_path}' '{escaped_line}'")
```

`Set-Content` creates/overwrites, `Add-Content` appends.

### Step 4: Join and Execute

```python
ps_script = "; ".join(ps_cmds)
write_cmd = f'powershell -Command "{ps_script}"'
ssh_run(host, port, write_cmd, timeout=15)
```

## Common Pitfalls

### 1. Unescaped Single Quotes

**Wrong:**
```python
cmd = "powershell -Command \"Write-Host 'Hello World'\""
```

**Right:**
```python
cmd = "powershell -Command \"Write-Host ''Hello World''\""
```

Or avoid single quotes in the content when possible.

### 2. Backslash Doubling

**Wrong:**
```python
path = "C:\Program Files\Tailscale"  # \P and \T are escape sequences
```

**Right:**
```python
path = "C:\\Program Files\\Tailscale"
# or
path = r"C:\Program Files\Tailscale"  # raw string
```

### 3. Variable Interpolation Timing

**Problem:** When does the variable get expanded?

```python
# This expands in Python before SSH
cmd = f"powershell -Command \"$env:PATH\""  # Shows remote PATH

# This keeps the variable for PowerShell
cmd = 'powershell -Command "$env:PATH"'  # Also shows remote PATH
```

Both work here, but be careful with mixed Python and PowerShell variables.

### 4. Newlines in Commands

**Wrong:**
```python
cmd = """powershell -Command "
    Write-Host 'Line 1'
    Write-Host 'Line 2'
"""
```

The SSH command treats newlines specially.

**Right:**
```python
cmd = 'powershell -Command "Write-Host ''Line 1''; Write-Host ''Line 2''"'
```

Use semicolons instead of newlines.

## Alternative: Here-Strings

For very complex scripts, consider writing a script file first:

```python
# Write script to temp file locally
with open('/tmp/script.ps1', 'w') as f:
    f.write(script_content)

# Copy via SCP
subprocess.run(['scp', '/tmp/script.ps1', f'{host}:C:/temp/'])

# Execute remotely
ssh_run(host, port, 'powershell -ExecutionPolicy Bypass -File C:\\temp\\script.ps1')
```

This avoids most escaping issues at the cost of an extra file transfer.

## Testing Escaping

To debug escaping issues, echo the command before execution:

```python
cmd = "powershell -Command \"Write-Host 'test'\""
print(f"Executing: {cmd}")
ssh_run(host, port, cmd)
```

Or test locally first:
```bash
ssh user@host "powershell -Command \"Write-Host 'test'\""
```

## Reference Table

| Character | In Python String | In PowerShell Single Quote | Combined |
|-----------|------------------|---------------------------|----------|
| `\` | `\\` | `\` | `\\` |
| `'` | `'` | `''` | `''''` (rare) |
| `"` | `\"` | `"` | `\\\"` |
| `$` | `$` | `$` (literal) | `$` |
| `` ` `` | `` ` `` | `` ` `` | `` ` `` |

## Related

- `./windows-ipn-limitation.md` - Context for why script creation is needed
- `../examples/ssh-script-creation.md` - Full walkthrough
- `share-tools/src/mesh/commands/remote.py` - Implementation
